---
name: Dispatch Helm Release

on:
  push:
    tags:
      - '*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: Release tag to dispatch (X.Y.Z or vX.Y.Z)
        required: true
        type: string

permissions:
  contents: read

jobs:
  dispatch:
    name: Notify permesi-helm
    runs-on: ubuntu-latest
    steps:
      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "release" ]]; then
            raw="${{ github.event.release.tag_name }}"
            source_tag="${{ github.event.release.tag_name }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            raw="${GITHUB_REF#refs/tags/}"
            source_tag="${GITHUB_REF#refs/tags/}"
          else
            raw="${{ inputs.version }}"
            source_tag="${{ inputs.version }}"
          fi

          version="${raw#v}"
          if [[ ! "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Unsupported release tag '${raw}'. Expected X.Y.Z or vX.Y.Z." >&2
            exit 1
          fi

          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "source_tag=${source_tag}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.PERMESI_HELM_APP_ID }}
          private-key: ${{ secrets.PERMESI_HELM_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: permesi-helm

      - name: Dispatch release to permesi-helm
        shell: bash
        run: |
          set -euo pipefail

          cat > payload.json <<JSON
          {
            "event_type": "permesi-release",
            "client_payload": {
              "version": "${{ steps.meta.outputs.version }}",
              "source_repo": "${{ github.repository }}",
              "source_sha": "${{ github.sha }}",
              "source_tag": "${{ steps.meta.outputs.source_tag }}"
            }
          }
          JSON

          curl -fsSL \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/permesi/permesi-helm/dispatches \
            --data @payload.json
